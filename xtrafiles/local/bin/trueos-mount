#!/bin/sh
# Script to symlink autofs media in /autofs to /media
#Format:  <device node> <filesystem type> <device label>

# Only run as superuser
if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

show_usage()
{
  echo "usage: trueos-mount volume"
}

# Check for arguments
if [ -z $1 ] ; then
    show_usage
    exit 1
fi

dev=${1}
type=`fstyp /dev/${dev}`
if [ ${?} != 0 ]; then
return 1;
fi

volume=`fstyp -l /dev/${dev} | sed -e 's/[^ ]* //'`

if [ "${volume}m" == "m" ] ; then
  volume="NO_NAME_${dev}"
else
  volume="${volume}_${dev}"
fi

#find the associtated autofs dir
if [ -d /autofs/${volume} ] ; then
  auto_dir="/autofs/${volume}"
elif [ -d /autofs/${type} ] ; then
  auto_dir="/autofs/${type}"
elif [ -d /autofs/${dev} ] ; then
  auto_dir="/autofs/${dev}";
fi

if [ -z ${auto_dir} ] ; then
  #could not find corresponding autofs dir
 exit 1;
fi

#Record the device->label connection for later
echo ${volume} > /tmp/.${dev}
#make the symlink
ln -s "${auto_dir}" /media/"${volume}"

if [ -d /media/autofs ] ; then
  rm /media/autofs
fi
